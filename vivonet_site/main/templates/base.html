{% load i18n %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<title>VIVONET</title>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link href="{% static "bower_components/visjs/vis.css"%}" rel="stylesheet"/>

<link rel="stylesheet" href="{% static "bower_components/html-components/css/bootstrap.min.css"%}">
<!--><!-->
<link rel="stylesheet" href="{% static "bower_components/html-components/css/bootstrap-responsive.min.css"%}">
<!--><!-->
<link rel="stylesheet" href="{% static "bower_components/html-components/css/fullcalendar.css"%}">
<!--><!-->
<link rel="stylesheet" href="{% static "bower_components/html-components/css/matrix-style.css" %}">
<!--><!-->
<link rel="stylesheet" href="{% static "bower_components/html-components/css/matrix-media.css" %}">
<!--><!-->
<link rel="stylesheet" href="{% static "bower_components/html-components/font-awesome/css/font-awesome.css"  %}">
<!--><!-->
<link rel="stylesheet" href="{% static "bower_components/html-components/css/jquery.gritter.css" %}">
<!--><!-->
<link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700,800' rel='stylesheet' type='text/css'>
    <script src="{% static "bower_components/html-components/js/jquery.min.js" %}"></script>
<script src="{% static "bower_components/html-components/js/jquery.ui.custom.js" %}"></script>
<script src="{% static "bower_components/html-components/js/bootstrap.min.js" %}"></script>
<script src="{% static "bower_components/html-components/js/matrix.js" %}"></script>


<script type="text/javascript">
    /*
     * These cookies are set on the login page at login.html.
     * They are simply the IP address of your controller and the REST api port.
     * */
	/*
    var ipaddress = $.cookie('cip');
    if (ipaddress == null || ipaddress == "") window.location.href = "login.html";
    var restport = $.cookie('cport');
    if (restport == null || restport == "") window.location.href = "login.html";
	*/
	var ipaddress = '198.11.21.36';
	var dbaddress = '198.11.21.37';
	var dbport = '80';
	var restport = '8080';
    var nodes, edges;
    var details = '';
    var network = null;
    var DIR = '/static/bower_components/visjs/img/refresh-cl/';
    var EDGE_LENGTH_MAIN = 50;
    var EDGE_LENGTH_SUB = 50;
	nodes = new vis.DataSet();
	edges = new vis.DataSet();

    /*
    * This function draws the network and assigns actions to it as well.
    **/
    function draw() {
        // create a network
        var container = document.getElementById('mynetwork');
        var data = {
            nodes: nodes,
            edges: edges
        };
        var options = {
            autoResize: true,
            height: '100%',
            width: '100%',
            nodes: {shadow:true},
            edges: {shadow:true},
			//physics: false
        };
        network = new vis.Network(container, data, options);
//        network.fit({scale: 4.0});
        network.on("showPopup", function (params) {
            if (params.charAt(0) == 's') {
                var id = params.substring(1);
                network["body"]["nodes"][params]["options"]["title"] = parseFlows(id);
            }
        });

        network.on("click", function (params) {

			var details = "";
			if (params.nodes[0]){
					edges_list = params.edges;
					params.event = "[original event]";
					focusNode(params.nodes[0])
					dpid = params.nodes[0].substr(1)

				if (params.nodes[0].charAt(0) == 's'){
					details = fetchDetails(dpid, edges_list)
					//document.getElementById('eventSpan').innerHTML = '<h2>Click event:</h2>' + JSON.stringify(params, null, 4);
					document.getElementById('eventSpan').innerHTML = details;
				}
				if (params.nodes[0].charAt(0) == 'h'){
					host_ip = params.nodes[0].substr(1)
					customer = fetchCustomer();
					details = "<table class=\"table table-bordered\"><tbody><tr><td><a href=\"#\">Node IP</a></td><td>"+host_ip+"</td></tr>";
					details += "<tr><td><a href=\"#\">Node Location</a></td><td>"+customer[host_ip]+"</td></tr>";
					details += "</tbody></table>"

					document.getElementById('eventSpan').innerHTML = details

				}


			}
        });

    }
    function focusNode(nodeId) {

        var nodeId = nodeId
        var options = {
        // position: {x:positionx,y:positiony}, // this is not relevant when focusing on nodes
            scale: 1,
            animation: {
                duration: 1000,
                easingFunction: "easeOutQuad"
        }
      };
      network.focus(nodeId, options);
    }

    loadSwitches();
    function loadExternalLinks(hosts) { 														//Connect external links - Usually empty
        var url = "http://" + ipaddress + ":" + restport + "/wm/topology/external-links/json";
        $.ajax({
            url: url,
            success: function (data) {
                for (var i = 0; i < data.length; i++) {
                    edges.add({
                        from: "s" + data[i]["src-switch"],
                        to: "s" + data[i]["dst-switch"],
                        length: EDGE_LENGTH_MAIN,
                        id: data[i]["src-switch"] + "/" + data[i]["src-port"] + "-" + data[i]["dst-switch"] + "/" + data[i]["dst-port"],
                        title: data[i]["src-switch"] + "/" + data[i]["src-port"] + "<br>" + data[i]["dst-switch"] + "/" + data[i]["dst-port"],
                        color: 'black',
                        width: 2
                    });
                }
                for (var i = 0; i < hosts.length; i++) {
                    if (hosts[i]["attachmentPoint"].length > 0) {
                        if (hosts[i].hasOwnProperty("trueAttachmentPoint") && hosts[i]["trueAttachmentPoint"][0] != null) {
                            edges.add({
                                from: "h" + hosts[i]["ipv4"]
                                , to: "s" + hosts[i]["trueAttachmentPoint"][0].switch, length: EDGE_LENGTH_MAIN,
                                id: "h" + hosts[i]["ipv4"] + "-" + "s" + hosts[i]["trueAttachmentPoint"][0].switch, length: EDGE_LENGTH_MAIN,
                                title: hosts[i]["trueAttachmentPoint"][0].switch + "/" + hosts[i]["trueAttachmentPoint"][0].port,
                                color: 'green',
                                width: 2
                            });
                        }
                        else {
                            edges.add({
                                from: "h" + hosts[i]["ipv4"]
                                , to: "s" + hosts[i]["attachmentPoint"][0].switch, length: EDGE_LENGTH_MAIN,
                                id: "h" + hosts[i]["ipv4"] + "-" + "s" + hosts[i]["attachmentPoint"][0].switch, length: EDGE_LENGTH_MAIN,
                                title: hosts[i]["attachmentPoint"][0].switch + "/" + hosts[i]["attachmentPoint"][0].port,
                                color: 'green',
                                width: 2
                            });
                        }
                    }
                }
                loadInternalLinks();
                //draw();
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.log(jqXHR.responseText);
                alert('Error: ' + " " + jqXHR.responseText + " \n Status: " + textStatus + " \n Error Thrown: " +
                        errorThrown);
            }
        });
    }
    function loadInternalLinks(hosts) {
        $.ajax({
            url: "http://" + ipaddress + ":" + restport + "/wm/topology/links/json",
            success: function (data) {
                for (var i = 0; i < data.length; i++) {
                    edges.add({
                        from: "s" + data[i]["src-switch"], to: "s" + data[i]["dst-switch"], length: EDGE_LENGTH_MAIN,
                        id: data[i]["src-switch"] +  "-" + data[i]["dst-switch"],
						//id: "s" + data[i]["src-switch"] + "/" + data[i]["src-port"] + "-" + "s" + data[i]["dst-switch"] + "/" + data[i]["dst-port"],

                        title: data[i]["src-switch"] + "/" + data[i]["src-port"] + "<br>" + data[i]["dst-switch"] + "/" + data[i]["dst-port"],

                        color: 'black',
						width: 3
                    });
                }
                draw();
                //LoadExternalLinks(hosts);
            },
            error: function (jqXHR, textStatus, errorThrown) {
                alert('Error: ' + " " + jqXHR.responseText + " \n Status: " + textStatus + " \n Error Thrown: " +
                        errorThrown);
            }
        });
    }

    function parseFlows(id) {
        var flowString = "";	//Final Output Variable to be displayed on Hover
        $.ajax({
            url: "http://" + ipaddress + ":" + restport + "/wm/core/switch/" + id + "/flow/json",
            async: false,		//Setting async to false means that the statement you are calling has to complete before the next statement in your function can be called. If you set async: true then that statement will begin it's execution and the next statement will be called regardless of whether the async statement has completed yet.
            success: function (flowobject) {	//JSON Data fetched from URI
                for (var i = 0; i < flowobject["flows"].length; i++) {
                    flowString += "Flow " + i + ":";
                    flowString += "<br>&nbsp;&nbsp;&nbsp;Packet count: " + JSON.stringify(flowobject["flows"][i]["packet_count"]); //&nbsp -> TAB/SPACE character - JSON.stringify - converts javascript value to string
                    flowString += "<br>&nbsp;&nbsp;&nbsp;Matches: " + JSON.stringify(flowobject["flows"][i]["match"]);
                    if (flowobject["flows"][i]["version"] == "OF_13") {
                        flowString += "<br>&nbsp;&nbsp;&nbsp;Actions: " + JSON.stringify(flowobject["flows"][i]["instructions"]["instruction_apply_actions"]["actions"]);
                    }
                    if (flowobject["flows"][i]["version"] == "OF_10") {
                        flowString += "<br>&nbsp;&nbsp;&nbsp;Actions: " + JSON.stringify(flowobject["flows"][i]["actions"]["actions"]);
                    }
                    flowString += "<br>";
                }
            }
        });
        return flowString;
    }
    function loadSwitches() {
        $.ajax({
            url: "http://" + ipaddress + ":" + restport + "/wm/core/controller/switches/json",
            success: function (data) {
                for (var i = 0; i < data.length; i++) {
                    var id = "s" + data[i]["switchDPID"];		//ID
                    //var label = "s" + data[i]["switchDPID"];	//Switch Text - Label
                    var label = "OvS - " + String(i+1);	//Switch Text - Label
                    nodes.add({								//Push in Function Draw
                        id: id,
                        label: label,
                        image: DIR + 'switch.png',				//Image as node - DIR mentioned above
                        shape: 'image',
                        title: parseFlows(data[i]["switchDPID"])//Hover Details - Calling parseFlows function - Input Switch DPID
                    });
                }
                LoadHosts();
            },
            error: function (jqXHR, textStatus, errorThrown) {
                alert('Error: ' + " " + jqXHR.responseText + " \n Status: " + textStatus + " \n Error Thrown: " +
                        errorThrown);
            }
        });
    }
    function LoadHosts() {															//Extract Hosts for Nodes using /wm/device
        $.ajax({
            url: "http://" + ipaddress + ":" + restport + "/wm/device/",
            success: function (hosts) {
                hosts = hosts.devices;
				customer_name = fetchCustomer();
                for (var i = 0; i < hosts.length; i++) {
                    if (hosts[i]["attachmentPoint"].length > 0) {
                        var id = "h" + hosts[i]["ipv4"];
                        var label = customer_name[hosts[i]["ipv4"]];
                        //var label = id;

                        nodes.add({
                            id: id,
                            label: label,
                            image: DIR + 'cloud.png',
                            shape: 'image',
                            title: hosts[i]["mac"]
                        });
                    }
                }
                loadExternalLinks(hosts);
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.log(jqXHR.responseText);
                alert('Error: ' + " " + jqXHR.responseText + " \n Status: " + textStatus + " \n Error Thrown: " +
                        errorThrown);
            }
        });
    }


	function updateEdges(intent_path){
		path_arr = intent_path.split("-");
		var newColor = '#' + Math.floor((Math.random() * 255 * 255 * 255)).toString(16);
		//var newColor = 'green';

		edgeIDs = edges.getIds();
		for (var i = 0; i < edgeIDs.length; i++) {
			if ('h' == edgeIDs[i].charAt(0)){
			edges.update({
			id: edgeIDs[i],
			color: 'green',
			width: 3
			});
			}else{
			edges.update({
			id: edgeIDs[i],
			color: 'black',
			width: 3

			});
			}
			}
			console.log(intent_path);

		for (i=0;i < path_arr.length; i++){

			edge_id = path_arr[i] + "-" + path_arr[i+1];
			console.log(edge_id);
			edges.update({
			id:edge_id,
			color: newColor,
			width: 8

			});

			edge_id = path_arr[i+1] + "-" + path_arr[i];
			console.log(edge_id);
			edges.update({
			id:edge_id,
			color: newColor,
			width: 8
			});
		}
		//draw();
	}

	function fetchIntents(){
		$.ajax({
            url: "http://" + dbaddress + ":" + dbport + "/api/dropdown_data",
            success: function (intents) {
				$(document).ready(function(){

					$(".intent_name").remove();
				});
				if (intents.length != 0){
					for (var i = 0; i < intents.length; i++) {

						intent_name = intents[i]["name"];
						intent_path = intents[i]["path"];
						$(document).ready(function(){
							tag = "<li class='intent_name'><a href='#' onclick = \"updateEdges(\'" + intent_path+ "\')\"> <i class='icon-user'></i>"+intent_name+"</a></li>";
							$("#intent_list").append(tag);
						});
					}

					$(document).ready(function(){
							tag = "<li class='intent_name'><a href='#' onclick = \"resetEdges()\"> <i class='icon-user'></i>Reset Topology</a></li>";
							$("#intent_list").append(tag);
						});

				} else {

						$(document).ready(function(){
							$("#intent_list").append("<li class='intent_name'><div class='widget-content'>There are no intents configured</div></li>");
						});
				}
			}
		})

	}

	function resetEdges(){

		edgeIDs = edges.getIds();
		for (var i = 0; i < edgeIDs.length; i++) {
			if ('h' == edgeIDs[i].charAt(0)){
			edges.update({
			id: edgeIDs[i],
			color: 'green',
			width: 3

			});
			}else{
			edges.update({
			id: edgeIDs[i],
			color: 'black',
			width: 3
			});
			}
			//draw();
		}
	}


    function fetchCustomer() {
		$.ajax({
            url: "http://" + dbaddress+ ":" + dbport + "/api/customer_data",
			async: false,
            success: function (data) {
				customer_data = data;
                }
        });
		return customer_data;
    }

	function fetchDetails(dpid, edges_list){
	//var switch_details = "<div class=\"widget-content\"><table class=\"table table-bordered\"><tbody><tr><td><a href=\"#\">OvS DPID</a></td><td>"+dpid+"</td></tr>";
	var switch_details = "<table class=\"table table-bordered\"><tbody><tr><td><a href=\"#\">Switch DPID</a></td><td>"+dpid+"</td></tr>";

		$.ajax({
				url: "http://" + ipaddress+ ":" + restport + "/wm/core/controller/switches/json",
				async: false,
				success: function (data) {
					for(i=0; i<data.length; i++){
						if (data[i]["switchDPID"] == dpid){
						switch_details += "<tr><td><a href=\"#\">Management IP:</a></td><td>"+data[i]['inetAddress'].substr(1)+"</td></tr>"
						}
					}

				}
			});
		$.ajax({
				url: "http://" + ipaddress+ ":" + restport + "/wm/core/switch/"+dpid+"/desc/json",
				async: false,
				success: function (data) {
					switch_details += "<tr><td><a href=\"#\">Hardware Description:</a></td><td>"+data['desc']['hardware_description']+"</td></tr>";
					switch_details += "<tr><td><a href=\"#\">OpenFlow Version:</a></td><td>"+data['desc']['version']+"</td></tr>";
				}
		});


		switch_details += "</tbody></table>"
		//switch_details += "</tbody></table></div>"
		return switch_details;
	}

</script>
        <style type="text/css">
        #mynetwork {
            flex: 1;
            height: 550px;
            border: 1px solid lightgray;
            background-color: #f8f8f8;
        }
    </style>
    <!-- jQuery -->
<script src="{% static "bower_components/jquery/dist/jquery.min.js" %}"></script>


<!-- Page-Level Demo Scripts - Tables - Use for reference -->

<script src="{% static "bower_components/js/querystringparser.js" %}"></script>

<script src="{% static "bower_components/visjs/vis.js" %}"></script>
<script src="{% static "bower_components/visjs/googleAnalytics.js" %}"></script>

<script src="{% static "bower_components/js/jquery.cookie.js" %}"></script>

</head>
<body>

<!--Header-part-->
<div id="header">
  <h1><a href="/">VIVoNET</a></h1>
</div>
<!--close-Header-part-->


<!--top-Header-menu-->
<div id="user-nav" class="navbar navbar-inverse">
  <ul class="nav">
    <li  class="dropdown" id="profile-messages" ><a title="" href="#" data-toggle="dropdown" data-target="#profile-messages" class="dropdown-toggle"><i class="icon icon-user"></i>  <span class="text">Welcome User</span><b class="caret"></b></a>
      <ul class="dropdown-menu">
        <li><a href="#"><i class="icon-user"></i> My Profile</a></li>
        <li class="divider"></li>
        <li><a href="login.html"><i class="icon-key"></i> Log Out</a></li>
      </ul>
    </li>
    <li class=""><a title="" href="#"><i class="icon icon-cog"></i> <span class="text">Settings</span></a></li>
    <li class=""><a title="" href="{% url 'main_urls:logout' %}"><i class="icon icon-share-alt"></i> <span class="text">Logout</span></a></li>
  </ul>
</div>
<!--close-top-Header-menu-->

<!--sidebar-menu-->
<div id="sidebar"><a href="#" class="visible-phone"><i class="icon icon-home"></i> Dashboard</a>
  <ul>
    <li class="active"><a href="{% url 'main_urls:index' %}"><i class="icon icon-home"></i> <span>Home</span></a> </li>
    <li><a href="{% url 'main_urls:intent_engine' %}"><i class="icon icon-tint"></i> <span>Intent Engine</span></a> </li>
    <li><a href="{% url 'main_urls:topology' %}"><i class="icon icon-fullscreen"></i> <span>Network Topology</span></a> </li>
  </ul>
</div>
<!--sidebar-menu-->

{% block content %}
{% endblock %}
<!--Footer-part-->

<div class="row-fluid">
  <div id="footer" class="span12"> 2013 &copy; Matrix Admin. Brought to you by <a href="http://themedesigner.in">Themedesigner.in</a> </div>
</div>

<!--end-Footer-part-->

<script src="{% static "js/excanvas.min.js"%}"></script>
<script src="{% static "js/jquery.min.js"%}"></script>
<script src="{% static "js/jquery.ui.custom.js"%}"></script>
<script src="{% static "js/bootstrap.min.js"%}"></script>
<script src="{% static "js/jquery.flot.min.js"%}"></script>
<script src="{% static "js/jquery.flot.resize.min.js"%}"></script>
<script src="{% static "js/jquery.peity.min.js"%}"></script>
<script src="{% static "js/fullcalendar.min.js"%}"></script>
<script src="{% static "js/matrix.js"%}"></script>
<script src="{% static "js/matrix.dashboard.js"%}"></script>
<script src="{% static "js/jquery.gritter.min.js"%}"></script>
<script src="{% static "js/matrix.interface.js"%}"></script>
<script src="{% static "js/matrix.chat.js"%}"></script>
<script src="{% static "js/jquery.validate.js"%}"></script>
<script src="{% static "js/matrix.form_validation.js"%}"></script>
<script src="{% static "js/jquery.wizard.js"%}"></script>
<script src="{% static "js/jquery.uniform.js"%}"></script>
<script src="{% static "js/select2.min.js"%}"></script>
<script src="{% static "js/matrix.popover.js"%}"></script>
<script src="{% static "js/jquery.dataTables.min.js"%}"></script>
<script src="{% static "js/matrix.tables.js"%}"></script>

<script type="text/javascript">
  // This function is called from the pop-up menus to transfer to
  // a different page. Ignore if the value returned is a null string:
  function goPage (newURL) {

      // if url is empty, skip the menu dividers and reset the menu selection to default
      if (newURL != "") {

          // if url is "-", it is this page -- reset the menu:
          if (newURL == "-" ) {
              resetMenu();
          }
          // else, send page to designated URL
          else {
            document.location.href = newURL;
          }
      }
  }

// resets the menu selection upon entry to this page:
function resetMenu() {
   document.gomenu.selector.selectedIndex = 2;
}
</script>
</body>
</html>
